<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Collage</title>
    <link rel="stylesheet" href="css/style.css">    
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.2/underscore-min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/ocanvas/2.2.2/ocanvas.min.js"></script>
</head>

  <body>
    
    <div id="wrapper"> 

      <div id="left">
      <div id="nav" class="clearfix">
        <span class="colophon">
          <div class="slider"><span class="unit"></span></div>
        </span>
      </div>
        <ul id="palette">
        </ul>
      </div>
      <div id="right">
        <div id="surface">
          <span id='patient'></span>
          <span id='doctor'></span>
        </div>
        <canvas id="easel" width="100%" height="100%">

        </div>      
      </div>
    </div>

    <script type="text/javascript">
      var api_base = "http://api.are.na/v2/channels/";
      var main_slug = "collage-app";

      var nav_template = "<span class='nav-title'><a href='#' data-slug='<%= slug %>'><%- title %></a></span>";
      var media_template = '<li class="obj"><img src="<%= image.display.url %>"></li>';

      $(function() {

        $("#easel").attr('width', $(document).width() + 1);
        $("#easel").attr('height', $(document).height() + 1);

        var canvas = oCanvas.create({canvas: "#easel"});

        $.ajax({
          url: api_base + main_slug,
          dataType: "json",
          success: function(data){
            _.each(data.contents, function(channel){
              $("#nav").append(_.template(nav_template, channel));
            });
          }
        });

        $('#nav').delegate('.nav-title', 'click', function(e){
          e.preventDefault();
          slug = $(e.target).data('slug');
          
          $('.selected').removeClass('selected');
          $(e.target).addClass('selected');

          $.ajax({
            url: api_base + slug,
            dataType: "json",
            success: function(data){
              _.each(data.contents, function(block){
                if(block.class == 'Image'){
                  $("#palette").append(_.template(media_template, block));
                }
              });
            }
          });
        });

        $('#palette').delegate('.obj img', 'click', function(e){
            e.preventDefault();

            img_w = $(this).width();
            img_h = $(this).height();

            image_url = $(e.target).attr('src');
            image_obj = canvas.display.image({
              x: 0,
              y: 0,
              width: img_w,
              height: img_h,
              image: image_url
            });

            canvas.addChild(image_obj);
            image_obj.dragAndDrop({changeZindex: true});
        });

      });
    </script>

  </body>
</html>